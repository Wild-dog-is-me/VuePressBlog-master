{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{287:function(t,a,s){\"use strict\";s.r(a);var e=s(10),n=Object(e.a)({},(function(){var t=this,a=t._self._c;return a(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":t.$parent.slotKey}},[a(\"h1\",{attrs:{id:\"认识微服务\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#认识微服务\"}},[t._v(\"#\")]),t._v(\" 认识微服务\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"单体架构\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#单体架构\"}},[t._v(\"#\")]),t._v(\" 单体架构\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"单体架构\")]),t._v(\"：将业务的所有功能集中在一个项目中开发，打成一个包部署。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901083809.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8479f54cd3f937cedb6e.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"优点\")]),t._v(\"：架构简单，部署成本低\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"缺点\")]),t._v(\"：耦合度高（维护困难、升级困难）\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"分布式架构\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#分布式架构\"}},[t._v(\"#\")]),t._v(\" 分布式架构\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"分布式架构\")]),t._v(\"：根据业务功能对系统做拆分，每个业务功能模块作为独立项目开发，称为一个服务。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092921.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8479f54cd3f937cedc12.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"优点\")]),t._v(\"：降低服务耦合，有利于服务升级和拓展\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"缺点\")]),t._v(\"：服务调用关系错综复杂\")]),t._v(\" \"),a(\"p\",[t._v(\"分布式架构虽然降低了服务耦合，但是服务拆分时也有很多问题需要思考：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"服务拆分的粒度如何界定？\")]),t._v(\" \"),a(\"li\",[t._v(\"服务之间如何调用？\")]),t._v(\" \"),a(\"li\",[t._v(\"服务的调用关系如何管理？\")])]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"人们需要制定一套行之有效的标准来约束分布式架构。\")])]),t._v(\" \"),a(\"h2\",{attrs:{id:\"微服务\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#微服务\"}},[t._v(\"#\")]),t._v(\" 微服务\")]),t._v(\" \"),a(\"p\",[t._v(\"微服务的架构特征：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"单一职责：微服务拆分粒度更小，每一个服务都对应唯一的业务能力，做到单一职责\")]),t._v(\" \"),a(\"li\",[t._v(\"自治：团队独立、技术独立、数据独立，独立部署和交付\")]),t._v(\" \"),a(\"li\",[t._v(\"面向服务：服务提供统一标准的接口，与语言和技术无关\")]),t._v(\" \"),a(\"li\",[t._v(\"隔离性强：服务调用做好隔离、容错、降级，避免出现级联问题\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2022/202205162352847.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8479f54cd3f937cedbd4.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"微服务的上述特性\"),a(\"strong\",[t._v(\"其实是在给分布式架构制定一个标准\")]),t._v(\"，进一步降低服务之间的耦合度，提供服务的独立性和灵活性。做到高内聚，低耦合。\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"因此，可以认为微服务是一种经过良好架构设计的分布式架构方案 。\")])]),t._v(\" \"),a(\"p\",[t._v(\"其中在 Java 领域最引人注目的就是 SpringCloud 提供的方案了。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"springcloud\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#springcloud\"}},[t._v(\"#\")]),t._v(\" SpringCloud\")]),t._v(\" \"),a(\"p\",[t._v(\"SpringCloud 是目前国内使用最广泛的微服务框架。官网地址：https://spring.io/projects/spring-cloud。\")]),t._v(\" \"),a(\"p\",[t._v(\"SpringCloud 集成了各种微服务功能组件，并基于 SpringBoot 实现了这些组件的自动装配，从而提供了良好的开箱即用体验。\")]),t._v(\" \"),a(\"p\",[t._v(\"其中常见的组件包括：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901083717.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8479f54cd3f937cedbc9.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"另外，SpringCloud 底层是依赖于 SpringBoot 的，并且有版本的兼容关系，如下：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901084050.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8479f54cd3f937cedbce.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"内容知识\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#内容知识\"}},[t._v(\"#\")]),t._v(\" 内容知识\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092925.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847af54cd3f937cede7a.png\",alt:\"需要学习的微服务知识内容\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092925.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"需要学习的微服务知识内容\"),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901084131.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee207.png\",alt:\"技术栈\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901084131.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"技术栈\"),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090737.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee210.png\",alt:\"自动化部署\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090737.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"自动化部署\"),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"技术栈对比\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#技术栈对比\"}},[t._v(\"#\")]),t._v(\" 技术栈对比\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090726.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee209.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h1\",{attrs:{id:\"服务拆分\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务拆分\"}},[t._v(\"#\")]),t._v(\" 服务拆分\")]),t._v(\" \"),a(\"blockquote\",[a(\"p\",[t._v(\"代码参考：\")]),t._v(\" \"),a(\"p\",[t._v(\"Gitee：https://gitee.com/xn2001/cloudcode/tree/master/01-cloud-demo\")]),t._v(\" \"),a(\"p\",[t._v(\"GitHub：https://github.com/lexinhu/cloudcode/tree/master/01-cloud-demo\")])]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"服务拆分注意事项\")])]),t._v(\" \"),a(\"p\",[t._v(\"单一职责：不同微服务，不要重复开发相同业务\")]),t._v(\" \"),a(\"p\",[t._v(\"数据独立：不要访问其它微服务的数据库\")]),t._v(\" \"),a(\"p\",[t._v(\"面向服务：将自己的业务暴露为接口，供其它微服务调用\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090745.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847af54cd3f937cede6b.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"cloud-demo：父工程，管理依赖\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"order-service：订单微服务，负责订单相关业务\")]),t._v(\" \"),a(\"li\",[t._v(\"user-service：用户微服务，负责用户相关业务\")])]),t._v(\" \"),a(\"p\",[t._v(\"要求：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"订单微服务和用户微服务都必须有\"),a(\"strong\",[t._v(\"各自的数据库\")]),t._v(\"，相互独立\")]),t._v(\" \"),a(\"li\",[t._v(\"订单服务和用户服务\"),a(\"strong\",[t._v(\"都对外暴露 Restful 的接口\")])]),t._v(\" \"),a(\"li\",[t._v(\"订单服务如果需要查询用户信息，\"),a(\"strong\",[t._v(\"只能调用用户服务的 Restful 接口\")]),t._v(\"，不能查询用户数据库\")])]),t._v(\" \"),a(\"p\",[t._v(\"微服务项目下，打开 idea 中的 Service，可以很方便的启动。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090750.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee27b.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"启动完成后，访问 http://localhost:8080/order/101\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090757.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee4ee.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h1\",{attrs:{id:\"远程调用\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#远程调用\"}},[t._v(\"#\")]),t._v(\" 远程调用\")]),t._v(\" \"),a(\"p\",[t._v(\"正如上面的服务拆分要求中所提到，订单服务如果需要查询用户信息，\"),a(\"strong\",[t._v(\"只能调用用户服务的 Restful 接口\")]),t._v(\"，不能查询用户数据库\")]),t._v(\" \"),a(\"p\",[t._v(\"因此我们需要知道 Java 如何去发送 http 请求，Spring 提供了一个 RestTemplate 工具，只需要把它创建出来即可。（即注入 Bean）\")]),t._v(\" \"),a(\"p\",[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df84adf54cd3f937cffa92.png\",alt:\"image-20220726140740412\"}})]),t._v(\" \"),a(\"p\",[t._v(\"发送请求，自动序列化为 Java 对象。\")]),t._v(\" \"),a(\"p\",[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df84d2f54cd3f937d0d327.png\",alt:\"image-20220726140818005\"}})]),t._v(\" \"),a(\"p\",[t._v(\"启动完成后，访问：http://localhost:8080/order/101\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090909.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df847bf54cd3f937cee4ea.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"在上面代码的 url 中，我们可以发现调用服务的地址采用硬编码，这在后续的开发中肯定是不理想的，这就需要\"),a(\"strong\",[t._v(\"服务注册中心\")]),t._v(\"（Eureka）来帮我们解决这个事情。\")]),t._v(\" \"),a(\"h1\",{attrs:{id:\"eureka注册中心\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#eureka注册中心\"}},[t._v(\"#\")]),t._v(\" Eureka注册中心\")]),t._v(\" \"),a(\"p\",[t._v(\"最广为人知的注册中心就是 Eureka，其结构如下：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090919.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f40d.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"order-service 如何得知 user-service 实例地址？\")])]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"user-service 服务实例启动后，将自己的信息注册到 eureka-server(Eureka服务端)，叫做\"),a(\"strong\",[t._v(\"服务注册\")])]),t._v(\" \"),a(\"li\",[t._v(\"eureka-server 保存服务名称到服务实例地址列表的映射关系\")]),t._v(\" \"),a(\"li\",[t._v(\"order-service 根据服务名称，拉取实例地址列表，这个叫\"),a(\"strong\",[t._v(\"服务发现\")]),t._v(\"或服务拉取\")])]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"order-service 如何从多个 user-service 实例中选择具体的实例？\")])]),t._v(\" \"),a(\"p\",[t._v(\"order-service从实例列表中利用\"),a(\"strong\",[t._v(\"负载均衡算法\")]),t._v(\"选中一个实例地址，向该实例地址发起远程调用\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"order-service 如何得知某个 user-service 实例是否依然健康，是不是已经宕机？\")])]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"user-service 会\"),a(\"strong\",[t._v(\"每隔一段时间(默认30秒)向 eureka-server 发起请求\")]),t._v(\"，报告自己状态，称为\"),a(\"strong\",[t._v(\"心跳\")])]),t._v(\" \"),a(\"li\",[t._v(\"当超过一定时间没有发送心跳时，eureka-server 会认为微服务实例故障，将该实例从服务列表中剔除\")]),t._v(\" \"),a(\"li\",[t._v(\"order-service 拉取服务时，就能将故障实例排除了\")])]),t._v(\" \"),a(\"hr\"),t._v(\" \"),a(\"p\",[t._v(\"接下来我们动手实践的步骤包括\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090932.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f498.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"搭建注册中心\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#搭建注册中心\"}},[t._v(\"#\")]),t._v(\" 搭建注册中心\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"搭建 eureka-server\")])]),t._v(\" \"),a(\"p\",[t._v(\"引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 \"),a(\"strong\",[t._v(\"server\")])]),t._v(\" \"),a(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"org.springframework.cloud\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"spring-cloud-starter-netflix-eureka-server\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\")])]),a(\"p\",[a(\"strong\",[t._v(\"编写启动类\")])]),t._v(\" \"),a(\"p\",[t._v(\"注意要添加一个 \"),a(\"code\",[t._v(\"@EnableEurekaServer\")]),t._v(\" \"),a(\"strong\",[t._v(\"注解\")]),t._v(\"，开启 eureka 的\"),a(\"strong\",[t._v(\"注册中心\")]),t._v(\"功能\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-java line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"import\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token import\"}},[a(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[t._v(\"org\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"springframework\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"boot\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")])]),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"SpringApplication\")])]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"import\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token import\"}},[a(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[t._v(\"org\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"springframework\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"boot\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"autoconfigure\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")])]),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"SpringBootApplication\")])]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"import\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token import\"}},[a(\"span\",{pre:!0,attrs:{class:\"token namespace\"}},[t._v(\"org\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"springframework\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"cloud\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"netflix\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"eureka\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),t._v(\"server\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")])]),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"EnableEurekaServer\")])]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[t._v(\"@SpringBootApplication\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[t._v(\"@EnableEurekaServer\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"public\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"class\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"EurekaApplication\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"{\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"public\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"static\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"void\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"main\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"String\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"[\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"]\")]),t._v(\" args\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"{\")]),t._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"SpringApplication\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"run\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"EurekaApplication\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"class\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\",\")]),t._v(\" args\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"}\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"}\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"7\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"8\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"9\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"10\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"11\")]),a(\"br\")])]),a(\"p\",[a(\"strong\",[t._v(\"编写配置文件\")])]),t._v(\" \"),a(\"p\",[t._v(\"编写一个 application.yml 文件，内容如下：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"server\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"port\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"10086\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"application\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" eureka\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"-\")]),t._v(\"server\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"eureka\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"client\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"service-url\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"defaultZone\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" http\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"//127.0.0.1\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"10086/eureka\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"7\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"8\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"9\")]),a(\"br\")])]),a(\"p\",[t._v(\"其中 \"),a(\"code\",[t._v(\"default-zone\")]),t._v(\" 是因为前面配置类开启了注册中心所需要配置的 eureka 的\"),a(\"strong\",[t._v(\"地址信息\")]),t._v(\"，因为 eureka 本身也是一个微服务，这里也要将自己注册进来，当后面 eureka \"),a(\"strong\",[t._v(\"集群\")]),t._v(\"时，这里就可以填写多个，使用 “,” 隔开。\")]),t._v(\" \"),a(\"p\",[t._v(\"启动完成后，访问 http://localhost:10086/\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090945.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f4aa.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"服务注册\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务注册\"}},[t._v(\"#\")]),t._v(\" 服务注册\")]),t._v(\" \"),a(\"blockquote\",[a(\"p\",[t._v(\"将 user-service、order-service 都注册到 eureka\")])]),t._v(\" \"),a(\"p\",[t._v(\"引入 SpringCloud 为 eureka 提供的 starter 依赖，注意这里是用 \"),a(\"strong\",[t._v(\"client\")])]),t._v(\" \"),a(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"org.springframework.cloud\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"spring-cloud-starter-netflix-eureka-client\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\")])]),a(\"p\",[t._v(\"在启动类上添加注解：\"),a(\"code\",[t._v(\"@EnableEurekaClient\")])]),t._v(\" \"),a(\"p\",[t._v(\"在 application.yml 文件，添加下面的配置：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"application\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \\t\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#name：orderservice\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" userservice\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"eureka\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"client\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"service-url\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"defaultZone\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" http\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"127.0.0.1\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"10086/eureka\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"7\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"8\")]),a(\"br\")])]),a(\"p\",[t._v(\"3个项目启动后，访问 http://localhost:10086/\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901090958.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f3cc.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"这里另外再补充个小技巧，我们可以通过 idea 的多实例启动，来查看 Eureka 的集群效果。\")]),t._v(\" \"),a(\"p\",[t._v(\"[\"),a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f469.png\",alt:\"img\"}})]),t._v(\" \"),a(\"p\",[t._v(\"4个项目启动后，访问 http://localhost:10086/\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091015.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8507f54cd3f937d1f574.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"服务拉取\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务拉取\"}},[t._v(\"#\")]),t._v(\" 服务拉取\")]),t._v(\" \"),a(\"blockquote\",[a(\"p\",[t._v(\"在 order-service 中完成服务拉取，然后通过负载均衡挑选一个服务，实现远程调用\")])]),t._v(\" \"),a(\"p\",[t._v(\"下面我们让 order-service 向 eureka-server 拉取 user-service 的信息，实现服务发现。\")]),t._v(\" \"),a(\"p\",[t._v(\"首先给 \"),a(\"code\",[t._v(\"RestTemplate\")]),t._v(\" 这个 Bean 添加一个 \"),a(\"code\",[t._v(\"@LoadBalanced\")]),t._v(\" \"),a(\"strong\",[t._v(\"注解\")]),t._v(\"，用于开启\"),a(\"strong\",[t._v(\"负载均衡\")]),t._v(\"。（后面会讲）\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-java line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[t._v(\"@Bean\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[t._v(\"@LoadBalanced\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"public\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"RestTemplate\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"restTemplate\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"{\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"return\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"new\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"RestTemplate\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"}\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\")])]),a(\"p\",[t._v(\"修改 OrderService 访问的url路径，用\"),a(\"strong\",[t._v(\"服务名\")]),t._v(\"代替ip、端口：\")]),t._v(\" \"),a(\"p\",[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df856af54cd3f937d40be3.png\",alt:\"image-20220726141049731\"}})]),t._v(\" \"),a(\"p\",[t._v(\"spring 会自动帮助我们从 eureka-server 中，根据 userservice 这个服务名称，获取实例列表后去完成负载均衡。\")]),t._v(\" \"),a(\"h1\",{attrs:{id:\"ribbon负载均衡\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#ribbon负载均衡\"}},[t._v(\"#\")]),t._v(\" Ribbon负载均衡\")]),t._v(\" \"),a(\"blockquote\",[a(\"p\",[t._v(\"代码参考：\")]),t._v(\" \"),a(\"p\",[t._v(\"Gitee：https://gitee.com/xn2001/cloudcode/tree/master/04-cloud-ribbon\")]),t._v(\" \"),a(\"p\",[t._v(\"GitHub：https://github.com/lexinhu/cloudcode/tree/master/04-cloud-ribbon\")])]),t._v(\" \"),a(\"p\",[t._v(\"我们添加了 \"),a(\"code\",[t._v(\"@LoadBalanced\")]),t._v(\" 注解，即可实现负载均衡功能，这是什么原理呢？\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"SpringCloud 底层提供了一个名为 Ribbon 的组件，来实现负载均衡功能。\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091242.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8599f54cd3f937d518ae.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"源码跟踪\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#源码跟踪\"}},[t._v(\"#\")]),t._v(\" 源码跟踪\")]),t._v(\" \"),a(\"p\",[t._v(\"为什么我们只输入了 service 名称就可以访问了呢？为什么不需要获取ip和端口，这显然有人帮我们根据 service 名称，获取到了服务实例的ip和端口。它就是\"),a(\"code\",[t._v(\"LoadBalancerInterceptor\")]),t._v(\"，这个类会在对 RestTemplate 的请求进行拦截，然后从 Eureka 根据服务 id 获取服务列表，随后利用负载均衡算法得到真实的服务地址信息，替换服务 id。\")]),t._v(\" \"),a(\"p\",[t._v(\"我们进行源码跟踪：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091323.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8599f54cd3f937d518b2.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"这里的 \"),a(\"code\",[t._v(\"intercept()\")]),t._v(\" 方法，拦截了用户的 HttpRequest 请求，然后做了几件事：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[a(\"code\",[t._v(\"request.getURI()\")]),t._v(\"：获取请求uri，即 http://user-service/user/8\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"originalUri.getHost()\")]),t._v(\"：获取uri路径的主机名，其实就是服务id \"),a(\"code\",[t._v(\"user-service\")])]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"this.loadBalancer.execute()\")]),t._v(\"：处理服务id，和用户请求\")])]),t._v(\" \"),a(\"p\",[t._v(\"这里的 \"),a(\"code\",[t._v(\"this.loadBalancer\")]),t._v(\" 是 \"),a(\"code\",[t._v(\"LoadBalancerClient\")]),t._v(\" 类型\")]),t._v(\" \"),a(\"p\",[t._v(\"继续跟入 \"),a(\"code\",[t._v(\"execute()\")]),t._v(\" 方法：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091330.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8599f54cd3f937d5194c.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"ul\",[a(\"li\",[a(\"code\",[t._v(\"getLoadBalancer(serviceId)\")]),t._v(\"：根据服务id获取 \"),a(\"code\",[t._v(\"ILoadBalancer\")]),t._v(\"，而 \"),a(\"code\",[t._v(\"ILoadBalancer\")]),t._v(\" 会拿着服务 id 去 eureka 中获取服务列表。\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"getServer(loadBalancer)\")]),t._v(\"：利用内置的负载均衡算法，从服务列表中选择一个。在图中\"),a(\"strong\",[t._v(\"可以看到获取了8082端口的服务\")])])]),t._v(\" \"),a(\"p\",[t._v(\"可以看到获取服务时，通过一个 \"),a(\"code\",[t._v(\"getServer()\")]),t._v(\" 方法来做负载均衡:\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091345.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8599f54cd3f937d519ba.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"我们继续跟入：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091355.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8599f54cd3f937d519ad.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"继续跟踪源码 \"),a(\"code\",[t._v(\"chooseServer()\")]),t._v(\" 方法，发现这么一段代码：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091414.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df859af54cd3f937d51acd.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"我们看看这个 \"),a(\"code\",[t._v(\"rule\")]),t._v(\" 是谁：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091432.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df859af54cd3f937d51b5a.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"这里的 rule 默认值是一个 \"),a(\"code\",[t._v(\"RoundRobinRule\")]),t._v(\" ，看类的介绍：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091442.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df859af54cd3f937d51b39.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"负载均衡默认使用了轮训算法，当然我们也可以自定义。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"流程总结\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#流程总结\"}},[t._v(\"#\")]),t._v(\" 流程总结\")]),t._v(\" \"),a(\"p\",[t._v(\"SpringCloud Ribbon 底层采用了一个拦截器，拦截了 RestTemplate 发出的请求，对地址做了修改。\")]),t._v(\" \"),a(\"p\",[t._v(\"基本流程如下：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"拦截我们的 \"),a(\"code\",[t._v(\"RestTemplate\")]),t._v(\" 请求 http://userservice/user/1\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"RibbonLoadBalancerClient\")]),t._v(\" 会从请求url中获取服务名称，也就是 user-service\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"DynamicServerListLoadBalancer\")]),t._v(\" 根据 user-service 到 eureka 拉取服务列表\")]),t._v(\" \"),a(\"li\",[t._v(\"eureka 返回列表，localhost:8081、localhost:8082\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"IRule\")]),t._v(\" 利用内置负载均衡规则，从列表中选择一个，例如 localhost:8081\")]),t._v(\" \"),a(\"li\",[a(\"code\",[t._v(\"RibbonLoadBalancerClient\")]),t._v(\" 修改请求地址，用 localhost:8081 替代 userservice，得到 http://localhost:8081/user/1，发起真实请求\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091755.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df859af54cd3f937d51c0f.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"负载均衡策略\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#负载均衡策略\"}},[t._v(\"#\")]),t._v(\" 负载均衡策略\")]),t._v(\" \"),a(\"p\",[t._v(\"负载均衡的规则都定义在 IRule 接口中，而 IRule 有很多不同的实现类：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091811.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df859af54cd3f937d51c0b.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"不同规则的含义如下：\")]),t._v(\" \"),a(\"table\",[a(\"thead\",[a(\"tr\",[a(\"th\",{staticStyle:{\"text-align\":\"left\"}},[a(\"strong\",[t._v(\"内置负载均衡规则类\")])]),t._v(\" \"),a(\"th\",{staticStyle:{\"text-align\":\"left\"}},[a(\"strong\",[t._v(\"规则描述\")])])])]),t._v(\" \"),a(\"tbody\",[a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"RoundRobinRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"简单轮询服务列表来选择服务器。它是Ribbon默认的负载均衡规则。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"AvailabilityFilteringRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"对以下两种服务器进行忽略：（1）在默认情况下，这台服务器如果3次连接失败，这台服务器就会被设置为“短路”状态。短路状态将持续30秒，如果再次连接失败，短路的持续时间就会几何级地增加。 （2）并发数过高的服务器。如果一个服务器的并发连接数过高，配置了AvailabilityFilteringRule 规则的客户端也会将其忽略。并发连接数的上限，可以由客户端设置。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"WeightedResponseTimeRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"为每一个服务器赋予一个权重值。服务器响应时间越长，这个服务器的权重就越小。这个规则会随机选择服务器，这个权重值会影响服务器的选择。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[a(\"strong\",[t._v(\"ZoneAvoidanceRule\")])]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"以区域可用的服务器为基础进行服务器的选择。使用Zone对服务器进行分类，这个Zone可以理解为一个机房、一个机架等。而后再对Zone内的多个服务做轮询。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"BestAvailableRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"忽略那些短路的服务器，并选择并发数较低的服务器。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"RandomRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"随机选择一个可用的服务器。\")])]),t._v(\" \"),a(\"tr\",[a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"RetryRule\")]),t._v(\" \"),a(\"td\",{staticStyle:{\"text-align\":\"left\"}},[t._v(\"重试机制的选择逻辑\")])])])]),t._v(\" \"),a(\"p\",[t._v(\"默认的实现就是 \"),a(\"code\",[t._v(\"ZoneAvoidanceRule\")]),t._v(\"，\"),a(\"strong\",[t._v(\"是一种轮询方案\")]),t._v(\"。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"自定义策略\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#自定义策略\"}},[t._v(\"#\")]),t._v(\" 自定义策略\")]),t._v(\" \"),a(\"p\",[t._v(\"通过定义 IRule 实现可以修改负载均衡规则，有两种方式：\")]),t._v(\" \"),a(\"p\",[t._v(\"1 代码方式在 order-service 中的 OrderApplication 类中，定义一个新的 IRule：\")]),t._v(\" \"),a(\"p\",[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df85caf54cd3f937d61d20.png\",alt:\"image-20220726141225760\"}})]),t._v(\" \"),a(\"p\",[t._v(\"2 配置文件方式：在 order-service 的 application.yml 文件中，添加新的配置也可以修改规则：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"userservice\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 给需要调用的微服务配置负载均衡规则，orderservice服务去调用userservice服务\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"ribbon\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"NFLoadBalancerRuleClassName\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" com.netflix.loadbalancer.RandomRule \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 负载均衡规则 \")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\")])]),a(\"p\",[a(\"strong\",[t._v(\"注意\")]),t._v(\"：一般用默认的负载均衡规则，不做修改。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"饥饿加载\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#饥饿加载\"}},[t._v(\"#\")]),t._v(\" 饥饿加载\")]),t._v(\" \"),a(\"p\",[t._v(\"当我们启动 orderservice，第一次访问时，时间消耗会大很多，这是因为 Ribbon 懒加载的机制。\")]),t._v(\" \"),a(\"p\",[t._v(\"[\"),a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8610f54cd3f937d79d0f.png\",alt:\"img\"}})]),t._v(\" \"),a(\"p\",[t._v(\"Ribbon 默认是采用懒加载，即第一次访问时才会去创建 LoadBalanceClient，拉取集群地址，所以请求时间会很长。\")]),t._v(\" \"),a(\"p\",[t._v(\"而饥饿加载则会在项目启动时创建 LoadBalanceClient，降低第一次访问的耗时，通过下面配置开启饥饿加载：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"ribbon\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"eager-load\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"enabled\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token boolean important\"}},[t._v(\"true\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"clients\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" userservice \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v('# 项目启动时直接去拉取userservice的集群，多个用\",\"隔开')]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\")])]),a(\"h1\",{attrs:{id:\"nacos注册中心\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#nacos注册中心\"}},[t._v(\"#\")]),t._v(\" Nacos注册中心\")]),t._v(\" \"),a(\"p\",[t._v(\"SpringCloudAlibaba 推出了一个名为 Nacos 的注册中心，在国外也有大量的使用。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091857.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8610f54cd3f937d79de9.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"解压启动 Nacos，详细请看 \"),a(\"a\",{attrs:{href:\"https://www.xn2001.com/archives/661.html\",target:\"_blank\",rel:\"noopener noreferrer\"}},[t._v(\"Nacos安装指南\"),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"div\",{staticClass:\"language- line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[t._v(\"startup.cmd -m standalone\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\")])]),a(\"p\",[t._v(\"访问：http://localhost:8848/nacos/\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091904.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8610f54cd3f937d79de6.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"服务注册-2\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#服务注册-2\"}},[t._v(\"#\")]),t._v(\" 服务注册\")]),t._v(\" \"),a(\"p\",[t._v(\"这里上来就直接服务注册，很多东西可能有疑惑，其实 Nacos 本身就是一个 SprintBoot 项目，这点你从启动的控制台打印就可以看出来，所以就不再需要去额外搭建一个像 Eureka 的注册中心。\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"引入依赖\")])]),t._v(\" \"),a(\"p\",[t._v(\"在 cloud-demo 父工程中引入 SpringCloudAlibaba 的依赖：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"com.alibaba.cloud\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"spring-cloud-alibaba-dependencies\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"version\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"2.2.6.RELEASE\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"version\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"type\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"pom\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"type\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"scope\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"import\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"scope\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"7\")]),a(\"br\")])]),a(\"p\",[t._v(\"然后在 user-service 和 order-service 中的pom文件中引入 nacos-discovery 依赖：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-xml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-xml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"com.alibaba.cloud\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"groupId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"<\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"spring-cloud-starter-alibaba-nacos-discovery\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"artifactId\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token tag\"}},[a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"</\")]),t._v(\"dependency\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\">\")])]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\")])]),a(\"p\",[a(\"strong\",[t._v(\"配置nacos地址\")])]),t._v(\" \"),a(\"p\",[t._v(\"在 user-service 和 order-service 的 application.yml 中添加 nacos 地址：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cloud\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"nacos\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"server-addr\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" 127.0.0.1\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"8848\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\")])]),a(\"p\",[t._v(\"项目重新启动后，可以看到三个服务都被注册进了 Nacos\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091918.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8610f54cd3f937d79e50.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"浏览器访问：http://localhost:8080/order/101，正常访问，同时负载均衡也正常。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"分级存储模型\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#分级存储模型\"}},[t._v(\"#\")]),t._v(\" 分级存储模型\")]),t._v(\" \"),a(\"p\",[t._v(\"一个\"),a(\"strong\",[t._v(\"服务\")]),t._v(\"可以有多个\"),a(\"strong\",[t._v(\"实例\")]),t._v(\"，例如我们的 user-service，可以有:\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"127.0.0.1:8081\")]),t._v(\" \"),a(\"li\",[t._v(\"127.0.0.1:8082\")]),t._v(\" \"),a(\"li\",[t._v(\"127.0.0.1:8083\")])]),t._v(\" \"),a(\"p\",[t._v(\"假如这些实例分布于全国各地的不同机房，例如：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"127.0.0.1:8081，在上海机房\")]),t._v(\" \"),a(\"li\",[t._v(\"127.0.0.1:8082，在上海机房\")]),t._v(\" \"),a(\"li\",[t._v(\"127.0.0.1:8083，在杭州机房\")])]),t._v(\" \"),a(\"p\",[t._v(\"Nacos就将同一机房内的实例，划分为一个\"),a(\"strong\",[t._v(\"集群\")]),t._v(\"。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091928.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a049.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"微服务互相访问时，应该尽可能访问同集群实例，因为本地访问速度更快。**当本集群内不可用时，才访问其它集群。**例如：杭州机房内的 order-service 应该优先访问同机房的 user-service。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091937.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d79fbd.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"配置集群\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置集群\"}},[t._v(\"#\")]),t._v(\" 配置集群\")]),t._v(\" \"),a(\"p\",[t._v(\"接下来我们给 user-service \"),a(\"strong\",[t._v(\"配置集群\")])]),t._v(\" \"),a(\"p\",[t._v(\"修改 user-service 的 application.yml 文件，添加集群配置：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cloud\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"nacos\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"server-addr\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" localhost\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"8848\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"discovery\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cluster-name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" HZ \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 集群名称 HZ杭州\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\")])]),a(\"p\",[t._v(\"重启两个 user-service 实例后，我们再去启动一个上海集群的实例。\")]),t._v(\" \"),a(\"div\",{staticClass:\"language- line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[t._v(\"-Dserver.port=8083 -Dspring.cloud.nacos.discovery.cluster-name=SH\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\")])]),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091947.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a00a.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"查看 nacos 控制台\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901091957.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a134.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h2\",{attrs:{id:\"nacosrule\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#nacosrule\"}},[t._v(\"#\")]),t._v(\" NacosRule\")]),t._v(\" \"),a(\"p\",[t._v(\"Ribbon的默认实现 \"),a(\"code\",[t._v(\"ZoneAvoidanceRule\")]),t._v(\" 并不能实现根据同集群优先来实现负载均衡，我们把规则改成 \"),a(\"strong\",[t._v(\"NacosRule\")]),t._v(\" 即可。我们是用 orderservice 调用 userservice，所以在 orderservice 配置规则。\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-java line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-java\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token annotation punctuation\"}},[t._v(\"@Bean\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"public\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"IRule\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[t._v(\"iRule\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"{\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"//默认为轮询规则，这里自定义为随机规则\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"return\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[t._v(\"new\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[t._v(\"NacosRule\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\";\")]),t._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"}\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\")])]),a(\"p\",[t._v(\"另外，你同样可以使用配置的形式来完成，具体参考上面的 Ribbon 栏目。\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"userservice\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"ribbon\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"NFLoadBalancerRuleClassName\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" com.alibaba.cloud.nacos.ribbon.NacosRule \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"#负载均衡规则 \")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\")])]),a(\"p\",[t._v(\"然后，再对 orderservice 配置集群。\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cloud\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"nacos\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"server-addr\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" localhost\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"8848\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"discovery\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cluster-name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" HZ \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 集群名称\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\")])]),a(\"p\",[t._v(\"现在我启动了四个服务，分别是：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"orderservice - HZ\")]),t._v(\" \"),a(\"li\",[t._v(\"userservice - HZ\")]),t._v(\" \"),a(\"li\",[t._v(\"userservice1 - HZ\")]),t._v(\" \"),a(\"li\",[t._v(\"userservice2 - SH\")])]),t._v(\" \"),a(\"p\",[t._v(\"访问地址：http://localhost:8080/order/101\")]),t._v(\" \"),a(\"p\",[t._v(\"在访问中我们发现，只有同在一个 HZ 集群下的 userservice、userservice1 会被调用，并且是随机的。\")]),t._v(\" \"),a(\"p\",[t._v(\"我们试着把 userservice、userservice2 停掉。依旧可以访问。\")]),t._v(\" \"),a(\"p\",[t._v(\"在 userservice3 控制台可以看到发出了一串的警告，因为 orderservice 本身是在 HZ 集群的，这波 HZ 集群没有了 userservice，就会去别的集群找。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"权重配置\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#权重配置\"}},[t._v(\"#\")]),t._v(\" 权重配置\")]),t._v(\" \"),a(\"p\",[t._v(\"实际部署中会出现这样的场景：\")]),t._v(\" \"),a(\"p\",[t._v(\"服务器设备性能有差异，部分实例所在机器性能较好，另一些较差，我们希望性能好的机器承担更多的用户请求。但默认情况下 NacosRule 是同集群内随机挑选，不会考虑机器的性能问题。\")]),t._v(\" \"),a(\"p\",[t._v(\"因此，Nacos 提供了\"),a(\"strong\",[t._v(\"权重配置来控制访问频率\")]),t._v(\"，0~1 之间，权重越大则访问频率越高，权重修改为 0，则该实例永远不会被访问。\")]),t._v(\" \"),a(\"p\",[t._v(\"在 Nacos 控制台，找到 user-service 的实例列表，点击编辑，即可修改权重。\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092020.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a1f0.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"在弹出的编辑窗口，修改权重\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092026.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a2ce.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"另外，在服务升级的时候，有一种较好的方案：我们也可以通过调整权重来进行平滑升级，例如：先把 userservice 权重调节为 0，让用户先流向 userservice2、userservice3，升级 userservice后，再把权重从 0 调到 0.1，让一部分用户先体验，用户体验稳定后就可以往上调权重啦。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"环境隔离\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#环境隔离\"}},[t._v(\"#\")]),t._v(\" 环境隔离\")]),t._v(\" \"),a(\"p\",[t._v(\"Nacos 提供了 namespace 来实现环境隔离功能。\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[t._v(\"Nacos 中可以有多个 namespace\")]),t._v(\" \"),a(\"li\",[t._v(\"namespace 下可以有 group、service 等\")]),t._v(\" \"),a(\"li\",[t._v(\"不同 namespace 之间\"),a(\"strong\",[t._v(\"相互隔离\")]),t._v(\"，例如不同 namespace 的服务互相不可见\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092032.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a47b.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h3\",{attrs:{id:\"创建namespace\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#创建namespace\"}},[t._v(\"#\")]),t._v(\" 创建namespace\")]),t._v(\" \"),a(\"p\",[t._v(\"默认情况下，所有 service、data、group 都在同一个 namespace，名为 public(保留空间)：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092038.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a39e.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"我们可以点击页面新增按钮，添加一个 namespace：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092050.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a3c0.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"然后，填写表单：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092059.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a3ae.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"就能在页面看到一个新的 namespace：\")]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092114.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a3f2.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"h3\",{attrs:{id:\"配置namespace\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#配置namespace\"}},[t._v(\"#\")]),t._v(\" 配置namespace\")]),t._v(\" \"),a(\"p\",[t._v(\"给微服务配置 namespace 只能通过修改配置来实现。\")]),t._v(\" \"),a(\"p\",[t._v(\"例如，修改 order-service 的 application.yml 文件：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cloud\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"nacos\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"server-addr\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" localhost\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[t._v(\"8848\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"discovery\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cluster-name\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" HZ\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"namespace\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" 492a7d5d\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"-\")]),t._v(\"237b\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"-\")]),t._v(\"46a1\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"-\")]),t._v(\"a99a\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\"-\")]),t._v(\"fa8e98e4b0f9 \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 命名空间ID\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"7\")]),a(\"br\")])]),a(\"p\",[t._v(\"重启 order-service 后，访问控制台。\")]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"public\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092143.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8611f54cd3f937d7a4df.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[a(\"strong\",[t._v(\"dev\")])]),t._v(\" \"),a(\"p\",[a(\"a\",{attrs:{href:\"https://cdn.xn2001.com/img/2021/20210901092130.png\",target:\"_blank\",rel:\"noopener noreferrer\"}},[a(\"img\",{attrs:{src:\"https://pic.imgdb.cn/item/62df8612f54cd3f937d7a536.png\",alt:\"img\"}}),a(\"OutboundLink\")],1)]),t._v(\" \"),a(\"p\",[t._v(\"此时访问 order-service，因为 namespace 不同，会导致找不到 userservice，控制台会报错。\")]),t._v(\" \"),a(\"h2\",{attrs:{id:\"临时实例\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#临时实例\"}},[t._v(\"#\")]),t._v(\" 临时实例\")]),t._v(\" \"),a(\"p\",[t._v(\"Nacos 的服务实例分为两种类型：\")]),t._v(\" \"),a(\"ul\",[a(\"li\",[a(\"strong\",[t._v(\"临时实例\")]),t._v(\"：如果实例宕机超过一定时间，会从服务列表剔除，\"),a(\"strong\",[t._v(\"默认的类型\")]),t._v(\"。\")]),t._v(\" \"),a(\"li\",[t._v(\"非临时实例：如果实例宕机，不会从服务列表剔除，也可以叫永久实例。\")])]),t._v(\" \"),a(\"p\",[t._v(\"配置一个服务实例为永久实例：\")]),t._v(\" \"),a(\"div\",{staticClass:\"language-yaml line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-yaml\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"spring\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n  \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"cloud\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"nacos\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n      \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"discovery\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token key atrule\"}},[t._v(\"ephemeral\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[t._v(\":\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token boolean important\"}},[t._v(\"false\")]),t._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[t._v(\"# 设置为非临时实例\")]),t._v(\"\\n\")])]),t._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[t._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[t._v(\"5\")]),a(\"br\")])]),a(\"p\",[t._v(\"另外，Nacos 集群\"),a(\"strong\",[t._v(\"默认采用AP方式(可用性)\")]),t._v(\"，当集群中存在非临时实例时，\"),a(\"strong\",[t._v(\"采用CP模式(一致性)\")]),t._v(\"；而 Eureka 采用AP方式，不可切换。\")]),t._v(\" \"),a(\"h1\",{attrs:{id:\"\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#\"}},[t._v(\"#\")])])])}),[],!1,null,null,null);a.default=n.exports}}]);","extractedComments":[]}